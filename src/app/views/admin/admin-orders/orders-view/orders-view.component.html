<mat-tab-group>
    <mat-tab label="Info">
        <div class="container-fluid details">
            <ng-container *ngIf="orderDetails; else noOrderDetails">
                <div class="row">
                    <div class="col-md-4">
                        <h5 class="mb-3">Order : #{{orderDetails.order_number + ' ('+orderDetails.order_number_text+')'}}</h5>
                        <p class="mb-1 mr-2">Order Type : {{orderDetails.order_type}}</p>
                        <p class="mb-1 mr-2">Order Created By :  <span [innerHTML]="_orderHelper.getOrderCreatedWay(orderDetails.created_by)"></span></p>
                        <p class="mb-1 mr-2">Created Date : {{orderDetails.created_at |  date:'dd-MM-yyyy hh:mm:ss a'}}</p>
                        <p class="mb-1 mr-2">Completed Date :{{orderDetails.order_place_datetime | date:'dd-MM-yyyy hh:mm:ss a'}}</p>
                        <p>
                            <span class="mr-2">System Status: </span>
                            <span class="m-0" [innerHTML]="_orderHelper.getSystemStatus(orderDetails.system_status)"></span>
                            <span class="mt-2 badge badge-pill badge-warning p-2"
                                *ngIf="orderDetails.is_payment_authorization_required">Payment Authorization
                                Required</span>
                        </p>

                        <table class="table table-sm mt-5">
                            <tbody>
                                <tr>
                                    <td>Consent Given</td>
                                    <td>
                                        <i class="fa fa-check text-success"
                                            *ngIf="orderDetails.is_consent_completed"></i>
                                        <i class="fa fa-times text-danger"
                                            *ngIf="!orderDetails.is_consent_completed"></i>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Address Selected</td>
                                    <td>
                                        <i class="fa fa-check text-success"
                                            *ngIf="orderDetails.is_address_selected"></i>
                                        <i class="fa fa-times text-danger"
                                            *ngIf="!orderDetails.is_address_selected"></i>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Payment Completed</td>
                                    <td>
                                        <i class="fa fa-check text-success"
                                            *ngIf="orderDetails.is_payment_completed"></i>
                                        <i class="fa fa-times text-danger"
                                            *ngIf="!orderDetails.is_payment_completed"></i>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Face Photo</td>
                                    <td>
                                        <i class="fa fa-check text-success"
                                            *ngIf="orderDetails.is_profile_upload_completed"></i>
                                        <i class="fa fa-times text-danger"
                                            *ngIf="!orderDetails.is_profile_upload_completed"></i>
                                    </td>
                                </tr>
                                <tr>
                                    <td>License Photo</td>
                                    <td>
                                        <i class="fa fa-check text-success"
                                            *ngIf="orderDetails.is_license_upload_completed"></i>
                                        <i class="fa fa-times text-danger"
                                            *ngIf="!orderDetails.is_license_upload_completed"></i>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Health Questions</td>
                                    <td>
                                        <i class="fa fa-check text-success"
                                            *ngIf="orderDetails.is_questions_completed"></i>
                                        <i class="fa fa-times text-danger"
                                            *ngIf="!orderDetails.is_questions_completed"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="mt-3">
                            <button  type="button" *ngIf="orderDetails.system_status == 'NONE'" (click)="sendMail(orderDetails._id)" [ngClass]="{'btn btn-sm btn-block btn-primary mb-2': true, 'disabled': loadingReminderButton}">
                                <span class="pr-2"><i class="fa fa-envelope-o" *ngIf="!loadingReminderButton"></i><i class="fa fa-spinner" *ngIf="loadingReminderButton"></i></span>{{ !loadingReminderButton ? 'Send Remineder Mail' : 'Sending...'}}
                            </button>
                            <button type="button" *ngIf="!orderDetails.is_payment_authorization_required && orderDetails.system_status && orderDetails.system_status != 'NONE'" class="mb-2 btn btn-sm btn-block btn-success" (click)="downloadReceipt('billing_statement')"><i class="mr-2 fas fa-download"></i>Billing Statement</button>
                            <button type="button" *ngIf="orderDetails.system_status && orderDetails.system_status =='REFUND_PROCESSED'" class="mb-2 btn btn-sm btn-block btn-primary" (click)="downloadReceipt('refund_receipt')"><i class="mr-2 fas fa-download"></i>Refund Receipt</button>
                            <button type="button" *ngIf="orderDetails.order_type == 'main' && orderDetails.prescribed_on" class="mb-2 btn btn-sm btn-block btn-primary" (click)="downloadOrderSummary()"><i class="mr-2 fas fa-download"></i>Order Summary</button>
                            <button type="button" *ngIf="orderDetails.system_status != 'REFUND_REQUESTED' && orderDetails.system_status !='REFUND_PROCESSED'" (click)="openRefundOrderModal()" class="mb-2 btn btn-sm btn-block btn-danger"><i class="fas fa-sync-alt mr-2" aria-hidden="true"></i>Refund Request</button>
                        </div>

                    </div>
                    <div class="col-md-4">
                        <h5 class="mb-3">Patient Details</h5>
                        <h6 class="mb-2  text-primary cursor-pointer" (click)="gotoPatientDetails()">{{patient.first_name}} {{patient.last_name}}</h6>
                        <p class="mb-1">DOB: {{ patient.date_of_birth | date:'dd-MM-yyyy' }} | Age: {{patient.age}}</p>
                        <p class="mb-0">Email: {{patient.email}}</p>
                        <p class="mb-0">Phone: {{patient.cell_phone_number}}</p>

                        <div class="mt-3">
                            <h5 class="mb-3">Shipping Address</h5>
                            <div *ngIf="orderDetails.shipping_address">
                                <p class="mb-0">{{ orderDetails.shipping_address.contact_name}}</p>
                                <p class="mb-0">{{ orderDetails.shipping_address.contact_number}}</p>
                                <p class="mb-0">{{ orderDetails.shipping_address.address_line_1 }}</p>
                                <p class="mb-0">{{ orderDetails.shipping_address?.address_line_2}}</p>

                                <p class="mb-0">
                                    {{  orderDetails.shipping_address.city+' , '+orderDetails.shipping_address.state + ' - '+orderDetails.shipping_address.zip_code }}
                                </p>
                            </div>
                            <div *ngIf="!orderDetails.shipping_address">
                                <p class="mb-0">Address not added yet.</p>
                            </div>
                            <div class="text-500"> Shipping Method : {{ orderDetails.shipping_method }} </div>
                            <button *ngIf="showChangeAddressBtn" class="btn btn-outline-primary btn-sm" type="button" (click)="openEditAddressModal()"><i class="fas fa-pencil-alt mr-2"></i>Change Address</button>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <h5 class="mb-2">Profile Photo</h5>
                        <app-image-preview *ngIf="orderDetails.customer_profile_photo" [imgPath]="orderDetails.customer_profile_photo" height="200" width="250" caption="Full Face Image"></app-image-preview>
                        <div *ngIf="!orderDetails.customer_profile_photo" class="text-center text-muted">
                            <h4><i class="fa fa-info-circle"></i></h4>
                            <h6>Not Added Yet</h6>
                        </div>

                        <h5 class="mt-3 mb-2">License Photo</h5>
                        <app-image-preview *ngIf="orderDetails.customer_license_photo"  [imgPath]="orderDetails.customer_license_photo" height="200" width="250" caption="License Image"></app-image-preview>
                        <div *ngIf="!orderDetails.customer_license_photo" class="text-center text-muted">
                            <h4><i class="fa fa-info-circle"></i></h4>
                            <h6>Not Added Yet</h6>
                        </div>

                    </div>


                </div>


                <div class="d-flex flex-row justify-content-start align-items-center  mt-2">
                    <div *ngIf="orderDetails.is_closed" class="ml-2 alert alert-dark">This Order has been Closed on date
                        {{orderDetails.order_closed_datetime | date: 'dd-MM-yyyy  hh:mm:ss a' }} , Reason :
                        {{orderDetails.order_closed_reason }}</div>
                </div>

                <div class="row mt-3">

                    <div class="col-md-12">
                        <div class="table-responsive">
                            <table class="table border-bottom table-borderless table-sm">
                                <thead class="thead-light">
                                    <tr>
                                        <th class="border-0">Products</th>
                                        <th class="border-0 text-center">Quantity</th>
                                        <th class="border-0 text-right">Rate</th>
                                        <th class="border-0 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="align-middle">
                                            <h6 class="mb-0 text-nowrap font-weight-bold">{{orderDetails.medicine_kit_details.name}}</h6>
                                        </td>
                                        <td class="align-middle text-center">{{ orderDetails.ordered_quantity }}</td>
                                        <td class="align-middle text-right">{{ orderDetails.rate_per_quantity | currency:'INR'}}</td>
                                        <td class="align-middle text-right">{{ orderDetails.line_total_amount | currency:'INR'}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="row no-gutters justify-content-end">
                            <div class="col-auto" *ngIf="orderDetails.is_payment_completed==1">
                                <table class="table table-sm table-borderless text-right">
                                    <tbody>
                                        <tr>
                                            <th class="text-900">Coupon Discount {{ orderDetails.payment &&
                                                orderDetails.payment.coupon_code?'( Coupon Code Used :
                                                '+orderDetails.payment.coupon_code+' )':'' }}</th>
                                            <td class="font-weight-semi-bold text-right">
                                                {{(orderDetails.coupon_discount||0) | currency:'INR'}}</td>
                                        </tr>
                                        <tr>
                                            <th class="text-900">Referral Discount {{ orderDetails.referral_code_details
                                                ? '( Referral Code Used :
                                                '+orderDetails.referral_code_details.referral_code+' )':''}}</th>
                                            <td class="font-weight-semi-bold text-right">
                                                {{(orderDetails.referral_discount||0) | currency:'INR'}}</td>
                                        </tr>
                                        <tr>
                                            <th class="text-900">Shipping Charges</th>
                                            <td class="font-weight-semi-bold text-right">{{(orderDetails.shipping_charge
                                                || 0) | currency:'INR'}}</td>
                                        </tr>
                                        <tr class="border-top">
                                            <th class="font-weight-bold">Total</th>
                                            <td class="font-weight-bold text-right">{{orderDetails.total_amount |
                                                currency:'INR' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table border-bottom table-borderless table-sm">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Charged From Payment Gateway</th>
                                        <th>Charged From Wallet</th>
                                        <th class="text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <p class="font-weight-bold">{{orderDetails.charged_from_paymentgateway | currency:'INR'}}</p>
                                            <div  *ngIf="orderDetails.payment_transactions && orderDetails.payment_transactions[0]">
                                                    <div class="media">
                                                        <div class="media-body" *ngIf="orderDetails.payment_transactions[0].payment_source == 'PAYMENT_GATEWAY'">
                                                            <p class="mb-0"><strong>Payment Method : </strong>{{ orderDetails.payment_transactions[0].details.method | titlecase }}</p>
                                                            <div *ngIf="orderDetails.payment_transactions[0].details.method=='netbanking'">
                                                              <p class="mb-0"><strong>Bank : </strong>{{ orderDetails.payment_transactions[0].details.bank }}</p>
                                                              <p class="mb-0"><strong>Bank Transaction ID : </strong>{{ orderDetails.payment_transactions[0].details.acquirer_data.bank_transaction_id }}</p>
                                                            </div>
                                                            <div *ngIf="orderDetails.payment_transactions[0].details.method=='upi'">
                                                              <p class="mb-0"><strong>RRN : </strong>{{ orderDetails.payment_transactions[0].details.acquirer_data.rrn }}</p>
                                                              <p class="mb-0"><strong>UPI Transaction ID : </strong>{{ orderDetails.payment_transactions[0].details.acquirer_data.upi_transaction_id }}</p>
                                                            </div>
                                                            <div *ngIf="orderDetails.payment_transactions[0].details.method=='wallet'">
                                                              <p class="mb-0"><strong>Wallet Name : </strong>{{ orderDetails.payment_transactions[0].details.wallet | titlecase }}</p>
                                                              <p class="mb-0" *ngIf="orderDetails.payment_transactions[0].details.acquirer_data.transaction_id"><strong>Transaction ID : </strong>{{ orderDetails.payment_transactions[0].details.acquirer_data.transaction_id }}</p>
                                                            </div>
                                                            <div *ngIf="orderDetails.payment_transactions[0].details.method=='card'">
                                                              <p class="mb-0" *ngIf="orderDetails.payment_transactions[0].details.card_id"><strong>Card ID : </strong>{{ orderDetails.payment_transactions[0].details.card_id }}</p>
                                                              <p class="mb-0"><strong>Authorization Code : </strong>{{ orderDetails.payment_transactions[0].details.acquirer_data.auth_code }}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                            </div>
                                        </td>
                                        <td class="font-weight-bold">{{orderDetails.charged_from_wallet | currency:'INR'}}
                                        </td>
                                        <td class="font-weight-bold text-right">{{orderDetails.total_amount | currency:'INR'}}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="table-responsive" *ngIf="orderDetails.refunded_total > 0">
                            <table class="table border-bottom table-borderless table-sm">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Refunded to PaymentGateway</th>
                                        <th>Refunded to Wallet</th>
                                        <th class="text-right">Refunded Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="font-weight-bold">{{orderDetails.refunded_in_paymentgateway | currency:'INR'}}
                                        </td>
                                        <td class="font-weight-bold">{{orderDetails.refunded_in_wallet | currency:'INR'}}
                                        </td>
                                        <td class="font-weight-bold text-right">{{orderDetails.refunded_total | currency:'INR'}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h5 class="mt-3">All Payment Transactions</h5>
                        <div class="table-responsive" *ngIf="orderDetails.payment_transactions">
                            <table class="table table-sm">
                                <thead class="thead-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Transaction Type</th>
                                        <th>Payment Source</th>
                                        <th>Amount Charged</th>
                                        <th>Charge Id</th>
                                        <th>Amount Refund</th>
                                        <th>Refund Id</th>
                                        <th>Datetime</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr [ngClass]="{'alert-success':transaction.transaction_type=='CHARGE' || transaction.transaction_type=='AUTHORIZE_AND_CAPTURE'}"
                                        *ngFor="let transaction of orderDetails.payment_transactions;let i=index;">
                                        <td>{{i+1}}</td>
                                        <td>{{transaction.transaction_type}}</td>
                                        <td>{{transaction.payment_source}}</td>
                                        <td>{{transaction.charged_amount | currency:'INR'}}</td>
                                        <td>
                                            <a *ngIf="transaction.payment_source=='PAYMENT_GATEWAY'" target="_blank"  href="https://dashboard.razorpay.com/app/payments/{{transaction.charge_id}}">{{transaction.charge_id}}</a>
                                            <span *ngIf="transaction.payment_source=='WALLET'"> {{transaction.charge_id ? 'Wallet Transaction #'+transaction.charge_id :''}}</span>
                                        </td>
                                        <td>{{transaction.refunded_amount | currency:'INR'}}</td>
                                        <td>
                                            <span
                                                *ngIf="transaction.refund_id && transaction.payment_source=='PAYMENT_GATEWAY'">{{transaction.refund_id}}</span>
                                            <span
                                                *ngIf="transaction.refund_id && transaction.payment_source=='WALLET'">{{'Wallet Transaction #'+transaction.refund_id}}</span>
                                        </td>
                                        <td>{{transaction.created_at | date:'dd-MM-yyyy hh:mm:ss a'}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>


                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Customer Status</th>
                                        <th>Technician Status</th>
                                        <th>Doctor Status</th>
                                        <th>Pharmacy Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <p class="m-0"
                                                [innerHTML]="_orderHelper.getCustomerStatus(orderDetails.customer_status)">
                                            </p>
                                        </td>
                                        <td>
                                            <p class="m-0"
                                                [innerHTML]="_orderHelper.getTechnicianStatus(orderDetails.technician_status)">
                                            </p>
                                        </td>
                                        <td>
                                            <p class="m-0"
                                                [innerHTML]="_orderHelper.getDoctorStatus(orderDetails.doctor_status)">
                                            </p>
                                        </td>
                                        <td>
                                            <p class="m-0"
                                                [innerHTML]="_orderHelper.getPharmacyStatus(orderDetails.pharmacy_status)">
                                            </p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <p class="mb-1"><strong class="mr-2">Created Date :
                                                </strong>{{orderDetails.created_at | date:'dd-MM-yyyy hh:mm:ss a'}}</p>
                                            <p class="mb-1"><strong class="mr-2">Completed Date :
                                                </strong>{{orderDetails.order_place_datetime | date:'dd-MM-yyyy hh:mm:ss a'}}</p>
                                        </td>
                                        <td>
                                                <p class="mb-1"><strong class="mr-2">Reviewed On : </strong>{{
                                                (orderDetails.reviewed_on | date:'dd-MM-yyyy hh:mm:ss a') || '--' }}</p>
                                        </td>
                                        <td>
                                            <p class="mb-1"><strong class="mr-2">Prescribed On : </strong>{{
                                                (orderDetails.prescribed_on | date:'dd-MM-yyyy hh:mm:ss a') || '--' }}</p>
                                        </td>
                                        <td>
                                            <p class="mb-1"><strong class="mr-2">Shipped On : </strong>{{
                                                (orderDetails.shipped_on | date:'dd-MM-yyyy hh:mm:ss a') || '--' }}</p>
                                            <p class="mb-1"><strong class="mr-2">Pickedup On : </strong>{{
                                                (orderDetails.picked_up_on | date:'dd-MM-yyyy hh:mm:ss a') || '--' }}</p>

                                        </td>
                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td>
                                            <p class="mb-1" *ngIf="orderDetails.tracking_url"><strong
                                                    class="mr-2">Tracking Id : </strong><a
                                                    class="btn btn-sm btn-outline-primary"
                                                    [href]="orderDetails.tracking_url" target="_blank">{{
                                                    orderDetails.tracking_id }}</a></p>
                                            <p class="mb-1" *ngIf="orderDetails.label_url"><strong class="mr-2">Shipping
                                                    Label : </strong><button class="btn btn-sm btn-primary"
                                                    type="button"
                                                    (click)="openShippingLabelToPrint(orderDetails.label_url)">View
                                                    Label</button></p>
                                        </td>

                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td>
                                            <ng-container *ngIf="orderDetails.reviewed_by_id; else elseNoTemplate">
                                                <p class="mb-1"><strong class="mr-2">Name :</strong>{{orderDetails.reviewed_by_id.first_name+' '+orderDetails.reviewed_by_id.last_name}}</p>
                                            </ng-container>
                                            <ng-template #elseNoTemplate>
                                                <div class="text-center text-muted">
                                                    <h4><i class="fa fa-info-circle"></i></h4>
                                                    <h6>Not Assigned Yet</h6>
                                                </div>
                                            </ng-template>
                                        </td>
                                        <td>
                                            <ng-container *ngIf="orderDetails.assigned_to_id; else elseTemplate">
                                                <p class="mb-1"><strong class="mr-2">Name :
                                                    </strong>{{orderDetails.assigned_to_id.professional_details.display_name}}</p>
                                                <p class="mb-1"><strong class="mr-2">Email :
                                                    </strong>{{orderDetails.assigned_to_id.email}}</p>
                                                <p class="mb-1"><strong class="mr-2">Phone :
                                                    </strong>{{orderDetails.assigned_to_id.cell_phone_number | mask:
                                                    '(000) 000-0000' || '-'}}</p>
                                                <p class="mb-1"><strong class="mr-2">Registration Number
                                                        :</strong>{{orderDetails.assigned_to_id.professional_details.registration_number}}</p>
                                            </ng-container>
                                            <ng-template #elseTemplate>
                                                <div class="text-center text-muted">
                                                    <h4><i class="fa fa-info-circle"></i></h4>
                                                    <h6>Not Assigned Yet</h6>
                                                </div>
                                            </ng-template>
                                        </td>
                                        <td>
                                            <ng-container
                                                *ngIf="orderDetails.assigned_to_pharmacy_id && orderDetails.assigned_to_pharmacy_id">
                                                <p class="mb-1"><strong class="mr-2">Name :
                                                    </strong>{{orderDetails.assigned_to_pharmacy_id.pharmacy_name}}</p>
                                                <p class="mb-1"><strong class="mr-2">Phone:
                                                    </strong>{{orderDetails.assigned_to_pharmacy_id.phone_number | mask: '(000)
                                                    000-0000' || '-'}}</p>
                                                <p class="mb-1"><strong class="mr-2">Fax:
                                                    </strong>{{orderDetails.assigned_to_pharmacy_id.fax_number | mask: '(000)
                                                    000-0000' || '-'}}</p>
                                                <p class="mb-1"><strong class="mr-2">NPI Number:
                                                    </strong>{{orderDetails.assigned_to_pharmacy_id.npi_number}}</p>
                                                <p class="mb-1"><strong class="mr-2">DEA Number:
                                                    </strong>{{orderDetails.assigned_to_pharmacy_id.dea_number}}</p>
                                            </ng-container>

                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </ng-container>
            <ng-template #noOrderDetails>
                <div class="text-center text-muted">
                    <h2><i class="fa fa-info-circle"></i></h2>
                    <h4>No Order Details!</h4>
                </div>
            </ng-template>
        </div>
    </mat-tab>

    <mat-tab label="Kit" *ngIf="orderDetails">
           <app-order-medicine-kit [orderDetails]="orderDetails"></app-order-medicine-kit>
    </mat-tab>
    <mat-tab label="Questionnaire">
        <div class="container-fluid doctorDetails">
            <app-order-question-answer [orderDetails]="orderDetails" (reloadOrderDetails)="getOrderDetailsAgain()"></app-order-question-answer>
        </div>
    </mat-tab>
    <mat-tab label="Logs">
        <app-order-logs></app-order-logs>
    </mat-tab>
</mat-tab-group>

<div class="form-group mt-1">
    <div class="text-center">
        <a routerLink="/admin/orders/list" routerLinkActive="active" class="btn btn-primary"><i  class="fa fa-arrow-left mr-2" aria-hidden="true"></i>Back To Orders</a>
    </div>
</div>
